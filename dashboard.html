<!DOCTYPE html>
<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script>
			//var HOSTNAME = 'https://backend.lmbutler-ssa.net';
			var HOSTNAME = 'http://localhost:8000';
			
			var clientToken="";

			$(window).load(function(){$(document).ready(function(){
				document.getElementById("dataSelector").selectedIndex = -1;
				var requestClientTokenUrl = HOSTNAME + "/dashboard?is_request_clientToken=true";
				$.ajax({
					url: requestClientTokenUrl,
					data: null,
					success: function(resp) {
						clientToken    =   resp;
						console.log(clientToken);
					},
					error: function(jqXHR, textStatus, errorThrown)
					{
						console.log(errorThrown);
						var redirectUrl = HOSTNAME + "/login";
						window.location = redirectUrl;
					},
					dataType: "text"
				});
			});});

			function showData()
			{
				var sortSelectValue, tableSelect, tableSelectValue, sortSelect, requestUrl;
				
				tableSelect=document.getElementById("dataSelector");
				//console.log(tableSelect.length);
				tableSelectValue = tableSelect.options[tableSelect.selectedIndex].value;
				sortSelect=document.getElementById("sortCriteria");
				if(0!=sortSelect.length)
				{
					//console.log(sortSelect.length);
					sortSelectValue = sortSelect.options[sortSelect.selectedIndex].value;
				}
				//console.log(tableSelectValue);
				requestUrl = HOSTNAME + "/"+tableSelectValue+"?client_access_token="+clientToken + '&sort_by={"'+sortSelectValue+'":"ASC"}';
				//console.log(requestUrl);

				$.ajax({
					url: requestUrl,
					data: null,
					success: function(resp) {
						//console.log(resp);
						//var formattedStr = JSON.stringify(resp, null, "\t");
						//$("#dataHolder").text(formattedStr);
						//$('#dataHolder').html(resp);
						var dataObj = $.parseJSON(resp);
						$("#dataHolder").html(JSON.stringify(dataObj,null,4));
						//$("#data")
						//console.log(sortSelect.options.length);
						
						var optionLen =sortSelect.length;
						//console.log("remove option len:"+optionLen);
						for(var i=0; i<optionLen;i++)
						{
							//console.log("index:"+ i +":" +sortSelect.options[i].text);
							//console.log("index:"+ i);
							sortSelect.remove(0);
						}
						if(0!=dataObj.length)
							for (var key in dataObj[0]) {
								var option = document.createElement("option");
								option.value= key;
								option.text = key;
								sortSelect.add(option);
								//console.log(' name=' + key + ' value=' + dataObj[0][key]);
							}
					},
					error: function(jqXHR, textStatus, errorThrown)
					{
						console.log(jqXHR);
						console.log($.parseJSON(jqXHR.responseText)["errormsg"]);
						$("#dataHolder").html($.parseJSON(jqXHR.responseText)["errormsg"]);
					},
					dataType: "text"
				});
			}
			
			function sortData()
			{
				var tableSelect=document.getElementById("dataSelector");
				var tableSelectValue = tableSelect.options[tableSelect.selectedIndex].value;
				var sortSelect=document.getElementById("sortCriteria");
				var sortSelectValue = sortSelect.options[sortSelect.selectedIndex].value;
				//console.log(tableSelectValue);
				var requestUrl = HOSTNAME + "/"+tableSelectValue+"?client_access_token="+clientToken + '&sort_by={"'+sortSelectValue+'":"ASC"}';
				//console.log(requestUrl);

				$.ajax({
					url: requestUrl,
					data: null,
					success: function(resp) {
						//console.log(resp);
						//var formattedStr = JSON.stringify(resp, null, "\t");
						//$("#dataHolder").text(formattedStr);
						//$('#dataHolder').html(resp);
						var dataObj = $.parseJSON(resp);
						$("#dataHolder").html(JSON.stringify(dataObj,null,4));
						//$("#data")
						//console.log(sortSelect.options.length);
					},
					error: function(jqXHR, textStatus, errorThrown)
					{
						console.log(jqXHR);
						console.log($.parseJSON(jqXHR.responseText)["errormsg"]);
						$("#dataHolder").html($.parseJSON(jqXHR.responseText)["errormsg"]);
					},
					dataType: "text"
				});
			}

			function signOut()
			{
				var redirectUrl = HOSTNAME + "/login?is_sign_out=true";
				window.location = redirectUrl;
			}

			function showAlert() {
				alert("Coming soon...");
			}

			function generateReport() {
				//pullData();
				// -- household name
				// -- total number in attendance
				// -- number of kids<5 in attendance
				// -- household ID
				// -- day,
				// -- time of day,
				// -- duration of visit,
				// -- health education topics clicked
				// -- done or not
				// -- services delivered
				// -- health assessments done

				// so we need visits, households to start
				// then eventually health_topics, services_accessed, CHA?

				//jQuery.when(tryPullAll()).done(createOutput())

				//var visitURL = HOSTNAME + "/visits?client_access_token="+clientToken;
				$.ajax({
					url: HOSTNAME + "/visits?client_access_token=" + clientToken,
					data: null,
					success: function(visitsJSON) {
						$.ajax({
							url: HOSTNAME + "/workers?client_access_token=" + clientToken,
							data: null,
							success: function(workersJSON) {
								populateHTML(visitsJSON, workersJSON);
							},
							error: function(jqXHR, textStatus, errorThrown)
							{
								console.log(jqXHR);
								console.log($.parseJSON(jqXHR.responseText)["errormsg"]);
								$("#dataHolder").html($.parseJSON(jqXHR.responseText)["errormsg"]);
							},
							dataType: "json"
						});
					},
					error: function(jqXHR, textStatus, errorThrown)
					{
						console.log(jqXHR);
						console.log($.parseJSON(jqXHR.responseText)["errormsg"]);
						$("#dataHolder").html($.parseJSON(jqXHR.responseText)["errormsg"]);
					},
					dataType: "json"
				});
			};

			function pullData() {

			};

			function cmp(x, y) {
			    return x > y ? 1 : x < y ? -1 : 0;
			};

			function populateHTML(visitsJSON, workersJSON) {
				// adapted from https://stackoverflow.com/questions/3230028/how-to-order-a-json-object-by-two-keys
				visitsJSON.sort(function(a, b) {
					aStart = new Date(a.start_time);
					bStart = new Date(b.start_time);
				    return cmp (
				        [cmp(a.worker_id, b.worker_id), cmp(aStart, bStart)],
				        [cmp(b.worker_id, a.worker_id), cmp(bStart, aStart)]
				    );
				});

				$("#dataHolder").html('');
				var htmlChunk = '';

				for (i = 0; i < visitsJSON.length; i++) {
					var sDate = visitsJSON[i].start_time;
					if (sDate != null) {
						sDate = new Date(visitsJSON[i].start_time).toUTCString();
					} else {
						sDate = 'Unknown or null';
					}
					var eDate = visitsJSON[i].end_time;
					if (eDate != null) {
						eDate = new Date(visitsJSON[i].end_time).toUTCString();
					} else {
						eDate = 'Unknown or null';
					}

					htmlChunk += '<div><span>Worker name: </span><span class="worker_name">' + getWorkerName(workersJSON, visitsJSON[i].worker_id) + '</span></div>';
					htmlChunk += '<div><span>Worker ID: </span><span class="worker-id">' + visitsJSON[i].worker_id + '</span></div>';
					// htmlChunk += '<div><span>Household name: </span><span class="hh-name">' +  + '</span></div>';
					htmlChunk += '<div><span>Household ID: </span><span class="hh-id">' + visitsJSON[i].hh_id + '</span></div>'
					htmlChunk += '<div><span>Start time: </span><span class="start-time">' + sDate + '</span></div>'
					htmlChunk += '<div><span>End time: </span><span class="end-time">' + eDate + '</span></div>'
					htmlChunk += '<div><span>Visit duration: </span><span class="duration">' + calcVisitLength(visitsJSON[i].start_time, visitsJSON[i].end_time) + '</span></div>'
					htmlChunk += '<div><span>Number of clients attending: </span><span class="attendance">' + visitsJSON[i].attendance.length + '</span></div>'
					// htmlChunk += '<div><span>Number of children under 5 attending: </span><span class="attendance-under-five>' +  + '</span></div>'
					// htmlChunk += '<div><span>Services delivered: </span><span class="services>' +  + '</span></div>'
					// htmlChunk += '<div><span>Health education: </span><span class="health-education>' +  + '</span></div>'
					// htmlChunk += '<div><span>Child health assessment complete: </span><span class="cha>' +  + '</span></div>'

					htmlChunk += '<br/>'
				}

				$('#report-container').html(htmlChunk);
			}

			function getWorkerName(json, id) {
				var name = '';
				$.each(json, function(i) {
					if (json[i]._id == id) {
						name = json[i].first_name + ' ' + json[i].last_name;
					}
				});
				return name;
			}

			function calcVisitLength(startTime, endTime) {
				var duration = new Date(endTime) - new Date(startTime);
				if (duration > 0) {
					return secondsToTime(duration / 1000);
				} else {
					return 'Incomplete or deleted';
				}
			}

			function secondsToTime(s)
			{
			    var h = Math.floor(s/3600); //Get whole hours
			    s -= h*3600;
			    var m = Math.floor(s/60); //Get remaining minutes
			    s -= m*60;
			    return h+":"+(m < 10 ? '0'+m : m)+":"+(s < 10 ? '0'+s : s); //zero padding on minutes and second
			}


		</script>
	</head>
	<body>
		<table cellpadding="5">
		  <tr>
			<td><button type="button" onClick='generateReport()'>Generate Report</button></td>
			<td>
				<span>Table: </span>
				<select id="dataSelector" onchange="showData()">
				  <option value="attendance">attendance</option>
				  <option value="clients">clients</option>
				  <option value="health_pages">health_pages</option>
				  <option value="health_selects">health_selects</option>
				  <option value="health_themes">health_themes</option>
				  <option value="health_topics">health_topics</option>
				  <option value="health_topics_accessed">health_topics_accessed</option>
				  <option value="households">households</option>
				  <option value="page_assessment1">page_assessment1</option>
				  <option value="page_select1">page_select1</option>
				  <option value="page_text1">page_text1</option>
				  <option value="page_video1">page_video1</option>
				  <option value="resources">resources</option>
				  <option value="resources_accessed">resources_accessed</option>
				  <option value="services">services</option>
				  <option value="services_accessed">services_accessed</option>
				  <option value="topic_videos">topic_videos</option>
				  <option value="vaccines">vaccines</option>
				  <option value="vaccines_recorded">vaccines_recorded</option>
				  <option value="videos">videos</option>
				  <option value="visits">visits</option>
				  <option value="workers">workers</option>
				</select>
			</td>
			<td>
				<span>Sort by: </span>
				<select id="sortCriteria" onchange="sortData()">
				  <option value="_id">id</option>
				  <option value="created_at">created_at</option>
				  <option value="modified_at">modified_at</option>
				</select>
			</td>
			<td><button type="button" onClick='signOut();'>Sign Out</button></td>
		  </tr>
		  <tr>
			<td colspan="2">
				<pre id="dataHolder" style="word-wrap: break-word; white-space: pre-wrap;"></pre>
			</td>
		  </tr>
		</table>

		<div id="report-container">

		</div>

	</body>
</html>
