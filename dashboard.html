<!DOCTYPE html>
<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script>
			var HOSTNAME = 'https://backend.lmbutler-ssa.net';

			var clientToken="";

			$(window).load(function(){$(document).ready(function(){
				document.getElementById("dataSelector").selectedIndex = -1;
				var requestClientTokenUrl = HOSTNAME + "/dashboard?is_request_clientToken=true";
				$.ajax({
					url: requestClientTokenUrl,
					data: null,
					success: function(resp) {
						clientToken    =   resp;
						console.log(clientToken);
					},
					error: function(jqXHR, textStatus, errorThrown)
					{
						console.log(errorThrown);
						var redirectUrl = HOSTNAME + "/login";
						window.location = redirectUrl;
					},
					dataType: "text"
				});
			});});

			function showData()
			{
				var tableSelect=document.getElementById("dataSelector");
				var tableSelectValue = tableSelect.options[tableSelect.selectedIndex].value;
				var sortSelect=document.getElementById("sortCriteria");
				var sortSelectValue = sortSelect.options[sortSelect.selectedIndex].value;
				console.log(tableSelectValue);
				var requestUrl = HOSTNAME + "/"+tableSelectValue+"?client_access_token="+clientToken + '&sort_by={"'+sortSelectValue+'":"ASC"}';
				console.log(requestUrl);
				$.ajax({
					url: requestUrl,
					data: null,
					success: function(resp) {
						console.log(resp);
						//var formattedStr = JSON.stringify(resp, null, "\t");
						//$("#dataHolder").text(formattedStr);
						//$('#dataHolder').html(resp);
						$("#dataHolder").html(JSON.stringify($.parseJSON(resp),null,4));
						//$("#data")
					},
					error: function(jqXHR, textStatus, errorThrown)
					{
						console.log(jqXHR);
						console.log($.parseJSON(jqXHR.responseText)["errormsg"]);
						$("#dataHolder").html($.parseJSON(jqXHR.responseText)["errormsg"]);
					},
					dataType: "text"
				});
			}

			function signOut()
			{
				var redirectUrl = HOSTNAME + "/login?is_sign_out=true";
				window.location = redirectUrl;
			}

			function showAlert() {
				alert("Coming soon...");
			}

			function generateReport() {
				//pullData();
				// -- household name
				// -- total number in attendance
				// -- number of kids<5 in attendance
				// -- household ID
				// -- day,
				// -- time of day,
				// -- duration of visit,
				// -- health education topics clicked
				// -- done or not
				// -- services delivered
				// -- health assessments done

				// so we need visits, households to start
				// then eventually health_topics, services_accessed, CHA?

				//jQuery.when(tryPullAll()).done(createOutput())

				var requestUrl = HOSTNAME + "/visits?client_access_token="+clientToken;
				$.ajax({
					url: requestUrl,
					data: null,
					success: function(resp) {
						populateHTML(resp);
					},
					error: function(jqXHR, textStatus, errorThrown)
					{
						console.log(jqXHR);
						console.log($.parseJSON(jqXHR.responseText)["errormsg"]);
						$("#dataHolder").html($.parseJSON(jqXHR.responseText)["errormsg"]);
					},
					dataType: "text"
				});
			};

			function pullData() {

			};

			function populateHTML(resp) {
				var htmlChunk = '';

				// THIS WILL NOT WORK, WHAT IS RESP's LENGTH. MORE IMPORTANT, NEED TO LOOK AT AN INDIVIDUAL VISIT
			// 	for (i = 0; i < resp.length, i++) {
			// 		resp[i].
			// 	}
			// <div><span>Worker name: </span><span class="first_name"></span><span class="last_name"></span></div>
			// <div><span>Worker ID: </span><span class="worker_id"></span></div>
			// <div><span>Household name: </span><span class="hh_name"></span></div>
			// <div><span>Household ID: </span><span class="hh_id"></span></div>

				$('#report-container').html('')

			}

			// function tryPullAllData() {
			//     var promise = jQuery.get(HOSTNAME + "/visits?client_access_token="+clientToken)
			//       .then(function (data) {
			//         var sortedData = _.sortBy(data, function (a) {
			//           return a._id;
			//         });
			//         _.each(sortedData, function(activity) {
			//           app.activityDropdownData.push(activity);
			//         });
			//         console.log("Activity Data pulled");
			//       });

			//     return promise;
			// };


		</script>
	</head>
	<body>
		<table cellpadding="5">
		  <tr>
			<td><button type="button" onClick='showAlert()'>Generate Report</button></td>
			<td>
				<span>Table: </span>
				<select id="dataSelector" onchange="showData()">
				  <option value="attendance">attendance</option>
				  <option value="clients">clients</option>
				  <option value="health_pages">health_pages</option>
				  <option value="health_selects">health_selects</option>
				  <option value="health_themes">health_themes</option>
				  <option value="health_topics">health_topics</option>
				  <option value="health_topics_accessed">health_topics_accessed</option>
				  <option value="households">households</option>
				  <option value="page_assessment1">page_assessment1</option>
				  <option value="page_select1">page_select1</option>
				  <option value="page_text1">page_text1</option>
				  <option value="page_video1">page_video1</option>
				  <option value="resources">resources</option>
				  <option value="resources_accessed">resources_accessed</option>
				  <option value="services">services</option>
				  <option value="services_accessed">services_accessed</option>
				  <option value="topic_videos">topic_videos</option>
				  <option value="vaccines">vaccines</option>
				  <option value="vaccines_recorded">vaccines_recorded</option>
				  <option value="videos">videos</option>
				  <option value="visits">visits</option>
				  <option value="workers">workers</option>
				</select>
			</td>
			<td>
				<span>Sort by: </span>
				<select id="sortCriteria" onchange="showData()">
				  <option value="_id">id</option>
				  <option value="created_at">created_at</option>
				  <option value="modified_at">modified_at</option>
				</select>
			</td>
			<td><button type="button" onClick='signOut();'>Sign Out</button></td>
		  </tr>
		  <tr>
			<td colspan="2">
				<pre id="dataHolder" style="word-wrap: break-word; white-space: pre-wrap;"></pre>
			</td>
		  </tr>
		</table>

		<div id="report-container">

		</div>

<!-- 		<div class="report-visit">
			<div><span>Worker name: </span><span class="first_name"></span><span class="last_name"></span></div>
			<div><span>Worker ID: </span><span class="worker_id"></span></div>
			<div><span>Household name: </span><span class="hh_name"></span></div>
			<div><span>Household ID: </span><span class="hh_id"></span></div>
		</div> -->

	</body>
</html>
