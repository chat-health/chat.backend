<!DOCTYPE html>
<html>
	<head>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
		<!-- CONFIRM THIS IS A STABLE LINK -->

		<script>
			var HOSTNAME = 'https://backend.lmbutler-ssa.net';
			//var HOSTNAME = 'http://localhost:8000';

			var clientToken="";

			$(window).load(function(){$(document).ready(function(){
				document.getElementById("dataSelector").selectedIndex = -1;
				var requestClientTokenUrl = HOSTNAME + "/dashboard?is_request_clientToken=true";
				$.ajax({
					url: requestClientTokenUrl,
					data: null,
					success: function(resp) {
						clientToken    =   resp;
						console.log(clientToken);
					},
					error: function(jqXHR, textStatus, errorThrown)
					{
						console.log(errorThrown);
						var redirectUrl = HOSTNAME + "/login";
						window.location = redirectUrl;
					},
					dataType: "text"
				});
			});});

			function showData()
			{
				var sortSelectValue, tableSelect, tableSelectValue, sortSelect, requestUrl;

				tableSelect=document.getElementById("dataSelector");
				//console.log(tableSelect.length);
				tableSelectValue = tableSelect.options[tableSelect.selectedIndex].value;
				sortSelect=document.getElementById("sortCriteria");
				if(0!=sortSelect.length)
				{
					//console.log(sortSelect.length);
					sortSelectValue = sortSelect.options[sortSelect.selectedIndex].value;
				}
				//console.log(tableSelectValue);
				requestUrl = HOSTNAME + "/"+tableSelectValue+"?client_access_token="+clientToken + '&sort_by={"'+sortSelectValue+'":"ASC"}';
				//console.log(requestUrl);

				$.ajax({
					url: requestUrl,
					data: null,
					success: function(resp) {
						//console.log(resp);
						//var formattedStr = JSON.stringify(resp, null, "\t");
						//$("#dataHolder").text(formattedStr);
						//$('#dataHolder').html(resp);
						$('#report-container').html('');
						var dataObj = $.parseJSON(resp);
						$("#dataHolder").html(JSON.stringify(dataObj,null,4));
						//$("#data")
						//console.log(sortSelect.options.length);

						var optionLen =sortSelect.length;
						//console.log("remove option len:"+optionLen);
						for(var i=0; i<optionLen;i++)
						{
							//console.log("index:"+ i +":" +sortSelect.options[i].text);
							//console.log("index:"+ i);
							sortSelect.remove(0);
						}
						if(0!=dataObj.length)
							for (var key in dataObj[0]) {
								var option = document.createElement("option");
								option.value= key;
								option.text = key;
								sortSelect.add(option);
								//console.log(' name=' + key + ' value=' + dataObj[0][key]);
							}
					},
					error: function(jqXHR, textStatus, errorThrown)
					{
						console.log(jqXHR);
						console.log($.parseJSON(jqXHR.responseText)["errormsg"]);
						$("#dataHolder").html($.parseJSON(jqXHR.responseText)["errormsg"]);
					},
					dataType: "text"
				});
			}

			function sortData()
			{
				var tableSelect=document.getElementById("dataSelector");
				var tableSelectValue = tableSelect.options[tableSelect.selectedIndex].value;
				var sortSelect=document.getElementById("sortCriteria");
				var sortSelectValue = sortSelect.options[sortSelect.selectedIndex].value;
				//console.log(tableSelectValue);
				var requestUrl = HOSTNAME + "/"+tableSelectValue+"?client_access_token="+clientToken + '&sort_by={"'+sortSelectValue+'":"ASC"}';
				//console.log(requestUrl);

				$.ajax({
					url: requestUrl,
					data: null,
					success: function(resp) {
						//console.log(resp);
						//var formattedStr = JSON.stringify(resp, null, "\t");
						//$("#dataHolder").text(formattedStr);
						//$('#dataHolder').html(resp);
						var dataObj = $.parseJSON(resp);
						$("#dataHolder").html(JSON.stringify(dataObj,null,4));
						//$("#data")
						//console.log(sortSelect.options.length);
					},
					error: function(jqXHR, textStatus, errorThrown)
					{
						console.log(jqXHR);
						console.log($.parseJSON(jqXHR.responseText)["errormsg"]);
						$("#dataHolder").html($.parseJSON(jqXHR.responseText)["errormsg"]);
					},
					dataType: "text"
				});
			}

			function signOut()
			{
				var redirectUrl = HOSTNAME + "/login?is_sign_out=true";
				window.location = redirectUrl;
			}

			function showAlert() {
				alert("Coming soon...");
			}

			function generateReport() {
				jQuery('#loading-text').show();

				$.when( pullData('visits'),
						pullData('workers'),
						pullData('households'),
						pullData('clients'),
						pullData('services'),
						pullData('services_accessed')
				).done(function(visitsJSON, workersJSON, householdsJSON, clientsJSON, servicesJSON, servicesAccessedJSON){
					jQuery('#loading-text').hide();
					populateHTML(cleanVisits(visitsJSON[0]), workersJSON[0], householdsJSON[0], clientsJSON[0], servicesJSON[0], servicesAccessedJSON[0]);
				});
			};

			function pullData(table) {
				var url = HOSTNAME + "/" + table + "?client_access_token=" + clientToken;
				return $.get(url);
			};

			function cmp(x, y) {
			    return x > y ? 1 : x < y ? -1 : 0;
			};

			function populateHTML(visitsJSON, workersJSON, householdsJSON, clientsJSON, servicesJSON, servicesAccessedJSON) {
				// adapted from https://stackoverflow.com/questions/3230028/how-to-order-a-json-object-by-two-keys
				visitsJSON.sort(function(a, b) {
					aStart = new Date(a.start_time);
					bStart = new Date(b.start_time);
				    return cmp (
				        [cmp(a.worker_id, b.worker_id), cmp(aStart, bStart)],
				        [cmp(b.worker_id, a.worker_id), cmp(bStart, aStart)]
				    );
				});

				$("#dataHolder").html('');
				var el = '<div>';
				var htmlChunk = '';

				var csvStr = 'Visit ID|Worker name|Worker ID|Household name|Household ID|Completion status|Start date|Start time|End date|End time|Visit duration|Clients attending|Number of clients attending|Number of children under 5 attending|Services delivered|Health topics completed';

				_.each(visitsJSON, function(visit) {
					var sDate, sTime;
					if (visit.start_time != null) {
						var d = new Date(visit.start_time);
						// note that cause the date object is such a mess, we need to add one to month (Jan = 0)
						var month = d.getMonth()+1;
						sDate = d.getFullYear() + '-' + month + '-' + d.getDate();
						sTime = d.getHours() + ':' + ('0'+d.getMinutes()).slice(-2);
					} else {
						sDate = 'Unknown or null';
						sTime = 'Unknown or null';
					}
					var eDate, eTime;
					if (visit.end_time != null) {
						var d = new Date(visit.end_time);
						var month = d.getMonth()+1;
						eDate = d.getFullYear() + '-' + month + '-' + d.getDate();
						eTime = d.getHours() + ':' + ('0'+d.getMinutes()).slice(-2);
					} else {
						eDate = 'Unknown or null';
						eTime = 'Unknown or null';
					}


					// order obviously matters here, don't mess with it
					var completeStatus = '';
					if (calcVisitLength(visit.start_time, visit.end_time) !== "Incomplete or deleted") {
						htmlChunk += '<div class="visit complete">';
						completeStatus = "Complete";
					} else if (checkSemiCompleteStatus(visit, servicesAccessedJSON, servicesJSON) === "Semi-complete") {
						htmlChunk += '<div class="visit semi-complete">';
						completeStatus = "Semi-complete";
					} else {
						htmlChunk += '<div class="visit incomplete">';
						completeStatus = "Incomplete or deleted";
					}

					htmlChunk += '<div class="hideable"><span class="report-row-header">Visit ID: </span><span class="visit_id">' + visit._id + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Worker name: </span><span class="worker_name">' + getWorkerName(workersJSON, visit.worker_id) + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Worker ID: </span><span class="worker-id">' + visit.worker_id + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Household name: </span><span class="hh-name">' + getHouseholdName(householdsJSON, visit.hh_id) + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Household ID: </span><span class="hh-id">' + visit.hh_id + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Completion status: </span><span class="complete-status">' + completeStatus + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Start date: </span><span class="start-date">' + sDate + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Start time: </span><span class="start-time">' + sTime + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">End date: </span><span class="end-date">' + eDate + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">End time: </span><span class="end-time">' + eTime + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Visit duration: </span><span class="duration">' + calcVisitLength(visit.start_time, visit.end_time) + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Clients attending: </span><span class="attendance">' + getAttendingClients(clientsJSON, visit) + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Number of clients attending: </span><span class="attendance-number">' + visit.attendance.length + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Number of children under 5 attending: </span><span class="attendance-under-five">' + getNumberAttendingUnderFive(clientsJSON, visit) + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Services delivered: </span><span class="services">' + getServicesAccessed(servicesAccessedJSON, servicesJSON, visit._id) + '</span></div>';
					htmlChunk += '<div class="hideable"><span class="report-row-header">Health topics completed: </span><span class="health-topics-completed">' + getHealthTopicsCompleted(visit.health_topics_accessed) + '</span></div>';
					// htmlChunk += '<div class="hideable"><span class="report-row-header">Child health assessment: </span><span class="cha">' + getCHACompleteStatus(visit) + '</span></div>'
					// htmlChunk += '<div class="hideable"><span class="report-row-header">Immunization: </span><span class="immunization">' + getImmunizationCompleteStatus(visit) + '</span></div>'

					htmlChunk += '</div><br />';

					csvStr += '\n'+visit._id+'|'+getWorkerName(workersJSON, visit.worker_id) +'|'+visit.worker_id+'|'+getHouseholdName(householdsJSON, visit.hh_id) +'|'+visit.hh_id+'|'+completeStatus+'|'+sDate+'|'+sTime+'|'+eDate+'|'+eTime+'|'+calcVisitLength(visit.start_time, visit.end_time)+'|'+getAttendingClients(clientsJSON, visit)+'|'+visit.attendance.length+'|'+getNumberAttendingUnderFive(clientsJSON, visit)+'|'+getServicesAccessed(servicesAccessedJSON, servicesJSON, visit._id)+'|'+getHealthTopicsCompleted(visit.health_topics_accessed)+'|'+getCHACompleteStatus(visit)+'|'+getImmunizationCompleteStatus(visit);
				});





				/*
					TO FIX:
					- visits need to be combined into one visit if on same date
					- all comma separated values need to be separated out into multiple columns
					- check times, maybe fix (times are UTC)
					- check dates, update month (FIXED)
					- do something with immunization and cha
					- clients attending, clients attending under 5, numbers of each
					- figure out services delivered, this is a very big mess
				*/

				// var csvStr = 'Worker name|Worker ID|Household name|Household ID|Start date|Start time|End date|End time|Visit duration|Clients attending|Number of clients attending|Number of children under 5 attending| Services delivered| Health topics completed|Child health assessment|Immunization';

				// csvStr += '\n'+getWorkerName(workersJSON, visit.worker_id) +'|'+visit.worker_id+'|'+getHouseholdName(householdsJSON, visit.hh_id) +'|'+visit.hh_id+'|'+sDate+'|'+sTime+'|'+eDate+'|'+eTime+'|'+calcVisitLength(visit.start_time, visit.end_time)+'|'+getAttendingClients(clientsJSON, visit)+'|'+visit.attendance.length+'|'+getNumberAttendingUnderFive(clientsJSON, visit)+'|'+getServicesAccessed(servicesAccessedJSON, servicesJSON, visit._id)+'|'+getHealthTopicsCompleted(visit.health_topics_accessed)+'|'+getCHACompleteStatus(visit)+'|'+getImmunizationCompleteStatus(visit);







				el += htmlChunk;
				el += '</div>';
				$('#report-container').html(el);

				// hide all of the incomplete visits so that they are expandable
				jQuery('.incomplete').addClass('hidden');
				jQuery('.incomplete').append('<div class="expanding-div">+</div>');
				jQuery('.incomplete .hideable').hide();

				jQuery('.incomplete').click(function() {
					if (jQuery(this).hasClass('hidden')) {
						jQuery(this).removeClass('hidden');
						jQuery('.expanding-div',this).remove();
						jQuery('.hideable',this).show();
					} else {
						jQuery(this).addClass('hidden');
						jQuery(this).append('<div class="expanding-div">+</div>');
						jQuery('.hideable',this).hide();
					}
				});

				jQuery('#download-report-btn').show();
				jQuery('#download-report-btn').click(function() {
					window.open('data:text/csv,' + encodeURIComponent(csvStr));
				});
			}


			// this function will concatenate all visits on the same day (same worker, HH, jesus this is hard)
			function cleanVisits(visitsJSON) {
				return visitsJSON;
			}

			function getWorkerName(json, id) {
				var worker = _.findWhere(json, {_id: id});
				return worker.first_name + ' ' + worker.last_name;
			}

			function getHouseholdName(json, id) {
				var household = _.findWhere(json, {_id: id});
				return household.hh_name;
			}

			function getAttendingClients(clients, visit) {
				var clientsStr = '';
				var attClients = _.filter(clients, function(c) {
				    return _.contains(visit.attendance,c._id);
				});

				_.each(attClients, function(client) {
					clientsStr += client.first_name;
					clientsStr += ' '
					clientsStr += client.last_name;
					clientsStr += ', ';
				});

				if (clientsStr.length > 0) {
					clientsStr = clientsStr.substr(0, clientsStr.length-2);
					return clientsStr;
				} else {
					return 'None';
				}
			}

			function getNumberAttendingUnderFive(clients, visit) {
				// go through each of the attendanceIds, find the corresponding client dob, compare to visitDate, add to array if less than 5 years
				var attClients = _.filter(clients, function(c) {
				    return _.contains(visit.attendance,c._id);
				});

				var attUnderFive = [];
				_.each(attClients, function(c) {
					if (getAge(visit.start_time, c.date_of_birth) <= 5) {
						attUnderFive.push(c);
					}
				});

				return attUnderFive.length;
			}

			function checkSemiCompleteStatus(visit, sAJSON, servicesJSON, htaArray) {
				var status = '';

				if (getServicesAccessed(sAJSON, servicesJSON, visit._id) !== "None" && getHealthTopicsCompleted(visit.health_topics_accessed) !== "None") {
					status = "Semi-complete";
				} else {
					status = "Not Semi-complete";
				}

				return status;
			}


			function getServicesAccessed(sAJSON, servicesJSON, visit_id) {
				var servicesStr = '';
				_.each(sAJSON, function(sa) {
					if (sa.visit_id == visit_id) {
						servicesStr += sa.service_id;
						servicesStr += ' (';
						service = _.findWhere(servicesJSON, {_id: sa.service_id});
						if (service) {
							servicesStr += service.en_name;
						} else {
							servicesStr += 'unknown service';
						}
						servicesStr += '), ';
					}
				});

				if (servicesStr.length > 0) {
					servicesStr = servicesStr.substr(0, servicesStr.length-2);
					return servicesStr;
				} else {
					return 'None';
				}
			}

			function getHealthTopicsCompleted(htaArray) {
				if (htaArray.length == 0) {
					return 'None';
				} else {
					var htaStr = '';
					_.each(htaArray, function(hta) {
						htaStr += hta.topic_name;
						if (hta.end_time == null || hta.end_time == "") {
							htaStr += ' (incomplete)';
						}
						htaStr += ', ';
					});

					if (htaStr.length > 0) {
						htaStr = htaStr.substr(0, htaStr.length-2);
					}

					return htaStr;
				}
			}

			function getCHACompleteStatus(visit) {
				var chaComStr = '';
				_.each(visit.cha_access, function(chaAcc) {
					if (chaAcc.type === "health") {
						if (chaAcc.end_time == null || chaAcc.end_time == "") {
							chaComStr += "Child health assessment started but incomplete";
						} else {
							chaComStr += "Child health assessment complete";
						}
					}
				});

				if (chaComStr.length === 0) {
					chaComStr += 'Child health assessment section not accessed';
				}

				return chaComStr;
			}

			function getImmunizationCompleteStatus(visit) {
				var immComStr = '';
				_.each(visit.cha_access, function(chaAcc) {
					if (chaAcc.type == "immunization") {
						if (chaAcc.end_time == null || chaAcc.end_time == "") {
							immComStr += "Immunization started but incomplete";
						} else {
							immComStr += "Immunization complete";
						}
					}
				});

				if (immComStr.length === 0) {
					immComStr = 'Immunization section not accessed';
				}

				return immComStr;
			}

			function calcVisitLength(startTime, endTime) {
				var duration = new Date(endTime) - new Date(startTime);
				if (duration > 0) {
					return secondsToTime(duration / 1000);
				} else {
					return 'Incomplete or deleted';
				}
			}

			function secondsToTime(s)
			{
			    var h = Math.floor(s/3600); //Get whole hours
			    s -= h*3600;
			    var m = Math.floor(s/60); //Get remaining minutes
			    s -= m*60;
			    return (h+":"+(m < 10 ? '0'+m : m)+":"+(s < 10 ? '0'+s : s)).substr(0,8); //zero padding on minutes and second, then cutting the trailing digits - probably a way nicer way to do this with floor
			}

			function getAge(visitDate, dob) {
				var visitDateMS = new Date(visitDate);
				var dobMS = new Date(dob);
				var ms = new Date(visitDate) - new Date(dob);
				var ageDate = new Date(ms); // miliseconds from epoch
				return Math.abs(ageDate.getUTCFullYear() - 1970);
			}

		</script>
		<style>
			.report-row-header {
				font-weight: bold;
			}
			.semi-complete {
				color: #D6A9A9;
			}
			.incomplete {
				color: #c3c3c3;
			}
		</style>
	</head>
	<body>
		<div id="loading-text" style="font-size: 30px; margin-top: 10%; margin-bottom: 80%; margin-left:45%; display: none">Loading...</div>
		<span style="float:right; width:100px; "><button type="button" onClick='signOut();'>Sign Out</button></span>

		<div style="padding:5px">
			<div style="margin: 10px 0px 40px 0px;"><button style="width: 190px; height: 65px; font-size: 20px;" type="button" onClick='generateReport()'>Generate Visit Report</button></div>

			<div>
				<div>View specific table data: </div>
				<select id="dataSelector" onchange="showData()">
				  <option value="attendance">attendance</option>
				  <option value="clients">clients</option>
				  <option value="health_pages">health_pages</option>
				  <option value="health_selects">health_selects</option>
				  <option value="health_themes">health_themes</option>
				  <option value="health_topics">health_topics</option>
				  <option value="health_topics_accessed">health_topics_accessed</option>
				  <option value="households">households</option>
				  <option value="page_assessment1">page_assessment1</option>
				  <option value="page_select1">page_select1</option>
				  <option value="page_text1">page_text1</option>
				  <option value="page_video1">page_video1</option>
				  <option value="resources">resources</option>
				  <option value="resources_accessed">resources_accessed</option>
				  <option value="services">services</option>
				  <option value="services_accessed">services_accessed</option>
				  <option value="topic_videos">topic_videos</option>
				  <option value="vaccines">vaccines</option>
				  <option value="vaccines_recorded">vaccines_recorded</option>
				  <option value="videos">videos</option>
				  <option value="visits">visits</option>
				  <option value="workers">workers</option>
				</select>

				<div>Sort table data by: </div>
				<select id="sortCriteria" onchange="sortData()">
				  <option value="_id">id</option>
				  <option value="created_at">created_at</option>
				  <option value="modified_at">modified_at</option>
				</select>
			</div>
<!-- 			<td>
				<span>Format: </span>
				<select id="formatCriteria" onchange="sortData()">
				  <option value="json">json</option>
				  <option value="xml">xml</option>
				</select>
			</td> -->

		  </div>


		  <div>
<!-- 			<td colspan="2"> -->
				<pre id="dataHolder" style="word-wrap: break-word; white-space: pre-wrap;"></pre>
<!-- 			</td> -->
		  </div>
		</div>

		<button id="download-report-btn" style="display:none; float:right; margin-top:8px; margin-right:10px">Download as csv</button>
		<div id="report-container" style="margin-top: 10px; border: 1px solid black; padding: 10px;">
			<!-- I GET FILLED BY REPORT GEN AND DROPDOWNS -->
		</div>

	</body>
</html>
